apiVersion: metal.sidero.dev/v1alpha2
kind: ServerClass
metadata:
  name: control-plane
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  selector:
    matchLabels:
      node/type: "controlplane"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: MetalMachineTemplate
metadata:
  name: main-cp
  namespace: default
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  template:
    spec:
      serverClassRef:
        apiVersion: metal.sidero.dev/v1alpha2
        kind: ServerClass
        name: control-plane
        namespace: default
---
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: TalosControlPlane
metadata:
  name: main-cp
  namespace: default
spec:
  controlPlaneConfig:
    controlplane:
      configPatches:
        - op: replace
          path: /machine/install/image
          value: gitea.hnatekmar.xyz/public/image-factory/amd-cpu:v1.11.2
        - op: add
          path: /cluster/apiServer/certSANs
          value:
            - hnatekmar.xyz
        - op: add
          path: /cluster/apiServer/extraArgs
          value:
            oidc-issuer-url: "https://sso.hnatekmar.xyz/auth/realms/master"
            oidc-client-id: "kubernetes"
            oidc-username-claim: "email"
            oidc-groups-claim: "groups"
            oidc-username-prefix: "sso:"
            oidc-groups-prefix: "sso:"
        - op: add
          path: /machine/network/interfaces
          value:
            - deviceSelector:
                physical: true # should select any hardware network device, if you have just one, it will be selected
              dhcp: true
              vip:
                ip: 172.16.100.10
        - op: replace
          path: /machine/install/disk
          value: /dev/sda
      generateType: controlplane
      talosVersion: v1.12.1
  infrastructureTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
    kind: MetalMachineTemplate
    name: main-cp
    namespace: default
  replicas: 1
  version: v1.34.1
